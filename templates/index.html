<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice OCR Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="ocrApp()">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-invoice mr-3 text-blue-600"></i>
                Invoice OCR Web App
            </h1>
            <p class="text-gray-600">Process invoices and documents with AI-powered OCR</p>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Model Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-brain text-2xl" 
                           :class="modelLoaded ? 'text-green-500' : 'text-yellow-500'"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-800">POINTS-Reader Model</h3>
                        <p class="text-sm" 
                           :class="modelLoaded ? 'text-green-600' : 'text-yellow-600'">
                            <span x-text="modelLoaded ? 'Ready for processing' : 'Loading...'"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Google Drive Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fab fa-google-drive text-2xl"
                           :class="driveConnected ? 'text-green-500' : 'text-gray-400'"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-800">Google Drive</h3>
                        <p class="text-sm"
                           :class="driveConnected ? 'text-green-600' : 'text-gray-600'">
                            <span x-text="driveConnected ? 'Connected' : 'Not connected'"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Interface -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button @click="activeTab = 'upload'" 
                            :class="activeTab === 'upload' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-upload mr-2"></i>Upload Files
                    </button>
                    <button @click="activeTab = 'drive'" 
                            :class="activeTab === 'drive' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fab fa-google-drive mr-2"></i>Google Drive
                    </button>
                    <button @click="activeTab = 'setup'" 
                            :class="activeTab === 'setup' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-cog mr-2"></i>Setup
                    </button>
                </nav>
            </div>

            <!-- Upload Tab -->
            <div x-show="activeTab === 'upload'" class="space-y-6">
                <div class="text-center">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Upload Invoice or Document</h2>
                    
                    <!-- File Upload Area -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4 hover:border-blue-400 transition-colors">
                        <input type="file" id="fileInput" class="hidden" accept=".png,.jpg,.jpeg,.pdf" 
                               @change="handleFileSelect($event)">
                        <label for="fileInput" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-lg text-gray-600 mb-2">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-500">PNG, JPG, JPEG, or PDF files</p>
                        </label>
                    </div>

                    <!-- Custom Prompt -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Prompt (Optional)</label>
                        <textarea x-model="customPrompt" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                  rows="3" 
                                  placeholder="e.g., Extract invoice number, date, total amount, and vendor name as JSON"></textarea>
                    </div>

                    <!-- Upload Button -->
                    <button @click="uploadFile()" 
                            :disabled="!selectedFile || !modelLoaded"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-play mr-2"></i>Process Document
                    </button>
                </div>
            </div>

            <!-- Google Drive Tab -->
            <div x-show="activeTab === 'drive'" class="space-y-6">
                <div x-show="!driveConnected" class="text-center text-gray-500">
                    <i class="fas fa-plug text-4xl mb-4"></i>
                    <p class="text-lg mb-4">Connect Google Drive to process your invoices</p>
                    <p class="text-sm">Go to Setup tab to upload your credentials</p>
                </div>

                <div x-show="driveConnected">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Your PDF Files</h2>
                        <button @click="loadDriveFiles()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-refresh mr-2"></i>Refresh
                        </button>
                    </div>

                    <!-- Drive Files List -->
                    <div class="space-y-3">
                        <template x-for="file in driveFiles" :key="file.id">
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                <div class="flex items-center">
                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                                    <div>
                                        <p class="font-medium text-gray-800" x-text="file.name"></p>
                                        <p class="text-sm text-gray-500" x-text="formatFileSize(file.size)"></p>
                                    </div>
                                </div>
                                <button @click="processDriveFile(file)" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    <i class="fas fa-play mr-2"></i>Process
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Setup Tab -->
            <div x-show="activeTab === 'setup'" class="space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Setup Google Drive Connection</h2>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-blue-800 mb-2">ðŸ“‹ Setup Instructions:</h3>
                    <ol class="list-decimal list-inside text-blue-700 space-y-1 text-sm">
                        <li>Go to <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a></li>
                        <li>Create a new project or select existing one</li>
                        <li>Enable the Google Drive API</li>
                        <li>Create OAuth 2.0 Client ID credentials</li>
                        <li>Download the JSON file and upload it below</li>
                    </ol>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <input type="file" id="credentialsInput" class="hidden" accept=".json" 
                           @change="handleCredentialsSelect($event)">
                    <label for="credentialsInput" class="cursor-pointer block text-center">
                        <i class="fas fa-key text-3xl text-gray-400 mb-4"></i>
                        <p class="text-lg text-gray-600 mb-2">Upload Google Drive Credentials</p>
                        <p class="text-sm text-gray-500">JSON file from Google Cloud Console</p>
                    </label>
                </div>

                <button @click="setupGoogleDrive()" 
                        :disabled="!credentialsFile"
                        class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fab fa-google-drive mr-2"></i>Connect Google Drive
                </button>
            </div>
        </div>

        <!-- Processing Status -->
        <div x-show="processing" class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="text-center">
                <i class="fas fa-cog fa-spin text-3xl text-blue-600 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-800 mb-2" x-text="processingStatus || 'Processing Document...'"></h3>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                         :style="`width: ${progress}%`"></div>
                </div>
                <p class="text-sm text-gray-600" x-text="`${progress}% complete`"></p>
            </div>
        </div>

        <!-- Results -->
        <div x-show="results.length > 0" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Processing Results</h2>
            
            <template x-for="result in results" :key="result.id">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800" x-text="result.filename"></h3>
                            <p class="text-sm text-gray-500" x-text="result.timestamp"></p>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="copyToClipboard(result.text)" 
                                    class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                            <button @click="downloadResult(result)" 
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                <i class="fas fa-download mr-1"></i>Download
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800" x-text="result.text"></pre>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script>
        function ocrApp() {
            return {
                activeTab: 'upload',
                modelLoaded: {{ model_loaded | lower }},
                driveConnected: {{ drive_connected | lower }},
                selectedFile: null,
                credentialsFile: null,
                customPrompt: '',
                processing: false,
                progress: 0,
                processingStatus: '',
                results: [],
                driveFiles: [],

                init() {
                    this.checkStatus();
                    if (this.driveConnected) {
                        this.loadDriveFiles();
                    }
                },

                async checkStatus() {
                    try {
                        const response = await fetch('/health');
                        const data = await response.json();
                        this.modelLoaded = data.model_loaded;
                        this.driveConnected = data.drive_connected;
                    } catch (error) {
                        console.error('Failed to check status:', error);
                    }
                },

                handleFileSelect(event) {
                    this.selectedFile = event.target.files[0];
                },

                handleCredentialsSelect(event) {
                    this.credentialsFile = event.target.files[0];
                },

                async uploadFile() {
                    if (!this.selectedFile) return;

                    const formData = new FormData();
                    formData.append('file', this.selectedFile);
                    formData.append('custom_prompt', this.customPrompt);

                    this.processing = true;
                    this.progress = 0;

                    try {
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        if (data.job_id) {
                            this.pollJobStatus(data.job_id);
                        }
                    } catch (error) {
                        console.error('Upload failed:', error);
                        this.processing = false;
                    }
                },

                async setupGoogleDrive() {
                    if (!this.credentialsFile) return;

                    const formData = new FormData();
                    formData.append('credentials', this.credentialsFile);

                    try {
                        const response = await fetch('/setup-google-drive', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        if (data.status === 'success') {
                            this.driveConnected = true;
                            this.loadDriveFiles();
                            alert('Google Drive connected successfully!');
                        }
                    } catch (error) {
                        console.error('Google Drive setup failed:', error);
                        alert('Failed to connect Google Drive');
                    }
                },

                async loadDriveFiles() {
                    try {
                        const response = await fetch('/drive-files');
                        const data = await response.json();
                        this.driveFiles = data.files;
                    } catch (error) {
                        console.error('Failed to load drive files:', error);
                    }
                },

                async processDriveFile(file) {
                    const formData = new FormData();
                    formData.append('file_id', file.id);
                    formData.append('file_name', file.name);
                    formData.append('custom_prompt', this.customPrompt);

                    this.processing = true;
                    this.progress = 0;

                    try {
                        const response = await fetch('/process-drive-file', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        if (data.job_id) {
                            this.pollJobStatus(data.job_id);
                        }
                    } catch (error) {
                        console.error('Processing failed:', error);
                        this.processing = false;
                    }
                },

                async pollJobStatus(jobId) {
                    const interval = setInterval(async () => {
                        try {
                            const response = await fetch(`/job-status/${jobId}`);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();

                            this.progress = data.progress || 0;
                            this.processingStatus = data.status || 'Processing...';

                            if (data.status === 'completed') {
                                clearInterval(interval);
                                this.processing = false;
                                this.processingStatus = '';
                                this.addResult(data);
                            } else if (data.status === 'error') {
                                clearInterval(interval);
                                this.processing = false;
                                this.processingStatus = '';
                                alert(`Processing failed: ${data.error}`);
                            }
                        } catch (error) {
                            console.error('Failed to check job status:', error);
                            clearInterval(interval);
                            this.processing = false;
                            this.processingStatus = '';
                            alert('Failed to check processing status: ' + error.message);
                        }
                    }, 1000);
                },

                addResult(data) {
                    this.results.unshift({
                        id: Date.now(),
                        filename: data.filename,
                        text: data.result,
                        timestamp: new Date().toLocaleString(),
                        savedFileId: data.saved_file_id
                    });
                },

                formatFileSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                async copyToClipboard(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        alert('Copied to clipboard!');
                    } catch (error) {
                        console.error('Failed to copy:', error);
                    }
                },

                downloadResult(result) {
                    const blob = new Blob([result.text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${result.filename}_OCR.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
        }
    </script>
</body>
</html>
